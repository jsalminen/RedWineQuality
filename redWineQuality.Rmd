Red Wine Quality by Juho Salminen
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

# Load required libraries
library(ggplot2)
library(reshape2)
library(RColorBrewer)
library(gridExtra)
library(e1071)
library(randomForest)
library(class)
library(knitr)

# Set ggplot theme
theme_set(theme_bw(15))
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
wine <- read.csv('wineQualityReds.csv', header = T)
```

# Introduction
This report explores the possibilities for identifying high quality red wines based on their chemical properties. Wine making and buying are often more art than science. Selecting a good wine for dinner from dozens of options is challenging for customers. Production also relies heavily on intuition and tradition. Although a tradition may well be  good and correct, developing one is difficult and can take decades. An easier and more robust way to assess wine quality and issues in it would be beneficial. 

As a first step towards an solution I will explore the wine quality dataset collected by P. Cortez, A. Cerdeira, F. Almeida, T. Matos and J. Reis (Modeling wine preferences by data mining from physicochemical properties. In Decision Support Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236). Dataset consists of measurements of various chemical properties of Portuguese vinho verde red wines and subjective quality assessment scores based on wine expert evaluations on a scale from 0 (very bad) to 10 (very excellent).
My goal is to explore whether it is possible to identify good wines just based on the measurements of chemical properties. In order to do so, I plan first to explore the distributions and correlations of different features with quality scores. If promising features for classification are identified, I'd like to try fitting a few 'quick and dirty' classification models to the dataset as a proof of concept for a recommendation system.

More information on the dataset is available at: https://s3.amazonaws.com/udacity-hosted-downloads/ud651/wineQualityInfo.txt

# Univariate Plots Section
```{r echo=FALSE, Univariate_Plots}
# Summaries and a sample of data
str(wine)
summary(wine)
head(wine)
```

The dataset consists of 1599 observations of 12 variables. Variable X appears to be just an id. Quality of wines is measured by integers between 3 and 8. I suppose the full scale is from 1 to 10, but for some reason extreme values have not been used. Other variables are continuous measures of physical qualities of the wine.

### Quality
```{r, echo=FALSE}
qplot(data = wine, as.factor(quality))

# Tabulate the counts in quality categories
table(wine$quality)
# Counts trasformed to percentages
round(table(wine$quality)/nrow(wine), 3) * 100
```

Distribution of wine qualities is bell-shaped with median 6 and mean 5.636. The left tail appears longer, but the right tail is heavier. It might make sense to combine categories, as some of them have only a few observations. 

```{r, echo=FALSE}
# Add binary variable for quality: 
# High = 7 or 8
# Low = 6 or lower quality score
wine$quality.bin <- 'Low'
wine$quality.bin[wine$quality >= 7] <- 'High'
wine$quality.bin <- factor(wine$quality.bin, levels = c('Low', 'High'))

qplot(quality.bin, data = wine)
table(wine$quality.bin)
by(wine$quality, wine$quality.bin, summary)
```
It might be easier to work with only two categories of wines instead of the full range of evaluations. The buyers are likely more interested in whether a wine is worth buying or not instead of exact ratings. Mean quality score for low quality wines is 5.4 and for high quality wines the mean is 7.1.  

### Acidity
```{r, echo=FALSE}
qplot(data = wine, fixed.acidity, binwidth = 0.2)
summary(wine$fixed.acidity)
```

Fixed acidity of the wines is concentated around the value 8, with some skew to the right. Most wines have the fixed acidity between 7 and 9.5. It will be interesting to see whether the best wines have the highest acidity. In that case they would be easy to identify.

```{r, echo=FALSE}
wine[wine$fixed.acidity > 15, ]
```
There are a few outliers. Weird, it looks like three of them could be repeated measurements of the same wine.

```{r, echo=FALSE}
qplot(data = wine, volatile.acidity, binwidth = 0.05)
summary(wine$volatile.acidity)
wine[wine$volatile.acidity > 1.5, ]
```

Volatile acidity is much lower than fixed acidity in absolute terms: mean volatile acidity is 0.578, compared to order of magnitude higher mean for fixed acidity. The distribution appears to have low variance with a few outlier to the right. The biggest outlier is of poor quality. Someone got wine-making really wrong?

```{r, echo=FALSE}
qplot(data = wine, volatile.acidity, binwidth = 0.02)
```

Increasing the resolution reveals an interesting chasm in the middle of the distribution. Why is this?

```{r, echo=FALSE}
qplot(data = wine, citric.acid, binwidth = 0.02)
summary(wine$citric.acid)
```

Many wines have zero or very little citric acid. Otherwise the distribution is quite flat until it starts to decrease around 0.5. There is a curious spike at this value, and a couple less distinct ones at lower values. It looks as if the wine makers might be aiming their wines to have the amount of citric acid either zero, 0.25 or 0.5. Maybe these spikes indicate different types of wines? 

```{r, echo=FALSE}
sort(table(wine$citric.acid), decreasing = T)
```

Actually the exact locations of the spikes are 0.24 and 0.49.

### Residual sugar
```{r, echo=FALSE}
qplot(data = wine, residual.sugar, binwidth = 0.2)
summary(wine$residual.sugar)
wine[wine$residual.sugar > 10, ]
```

Most wines have low amount of residual sugar, between about 1 and 3. Some examples have much higher amounts of residual sugars: the highest outlier has about 6 times higher amount of residual sugar than the average wine. They are perhaps of different type, like desert wines? None of the outliers are high quality wines. 

### Chlorides
```{r, echo=FALSE}
qplot(data = wine, chlorides, binwidth = 0.01)
summary(wine$chlorides)
wine[wine$chlorides > 0.3, ]
```

Distribution of chlorides resembles the one of residual sugar. Most values are thightly concentrated around 0.08 with a thin and long right tail all the way to 0.6. It looks as if there is a small concentration of wines around 0.4. Is this a distinct subtype or category of wines, or just an artefact in the data? With one exception the outliers are low quality wines. They are all dry (low residual sugar) and low on alcohol.

### Sulfur dioxide
```{r, echo=FALSE}
qplot(data = wine, free.sulfur.dioxide, binwidth = 2)
summary(wine$free.sulfur.dioxide)
```

Most wines have lowish amounts of free sulfur dioxide. The distribution is again right-skewed. In absolute terms the differences are large, from 1 g/l to 72 g/l.

```{r, echo=FALSE}
qplot(data = wine, total.sulfur.dioxide, binwidth = 5)
summary(wine$total.sulfur.dioxide)
```

Same story here as with free sulfur dioxide, but about an order of magnitude higher values. I wonder what is the relationship between free and total amounts of sulfur dioxide? 

```{r, echo=FALSE}
ggplot(wine, aes(free.sulfur.dioxide, total.sulfur.dioxide-free.sulfur.dioxide)) + 
  geom_point() + 
  geom_smooth()
```

There is a slightly increasing trend in additional sulfur dioxide when amount of free sulfur dioxide increases. It is still quite common for most of the total sulfur dioxide being accounted for by free sulfur dioxide. I'm creating a new variable fixed.sulfur.dioxide by calculating the difference between the two measures.

```{r, echo=FALSE}
# Create new variable fixed.sulfur.dioxide by subtracting free.sulfur.dioxide
# from total.sulfur.dioxide
wine$fixed.sulfur.dioxide <- wine$total.sulfur.dioxide - wine$free.sulfur.dioxide
qplot(fixed.sulfur.dioxide, data = wine)
summary(wine$fixed.sulfur.dioxide)
wine[wine$fixed.sulfur.dioxide > 200, ]
```

Similar distribution as with total sulfur dioxide. There are two extreme outliers, both of them high quality. Features of these two wines are curiously similar: the only difference is in amount of total sulfur dioxide. Duplicate?

### Density
```{r, echo=FALSE}
qplot(data = wine, density)
summary(wine$density)
```

Density is almost normally distributed around little less than 1, which makes sense as wine is mostly water, and alcohol is less dense than water. Density might actually be correlated with amount of alcholol.

```{r, echo=FALSE}
qplot(data = wine, alcohol, density) + 
  geom_smooth()
```

There indeed is a downward trend with increasing alcohol levels. Stronger wines tend to be less dense.

### pH
```{r, echo=FALSE}
qplot(data = wine, pH)
summary(wine$pH)
wine[wine$pH > 3.8 | wine$pH < 2.8, ]
```

pH of the wines is almost normally distributed around the mean pH 3.3. Wines are acidic. The few minor outliers are not interesting.

### Sulphates
```{r, echo=FALSE}
qplot(data = wine, sulphates, binwidth = 0.02)
summary(wine$sulphates)
wine[wine$sulphates > 1.5, ]
```

A relatively tight distribution with some skew and outliers to the right. Typical wines have sulphates between 0.5 and 0.8. All outliers are low quality wines low on residual sugar and alcohol. 

### Alcohol
```{r, echo=FALSE}
qplot(data = wine, alcohol, binwidth = 0.1) + 
  scale_x_continuous(breaks = seq(8,15,0.5))
summary(wine$alcohol)
sort(table(round(wine$alcohol, 2)), decreasing = TRUE)
```

Wines typically have at least 9 % alcohol, around 10 % being the average and number of wines slowly decreasing as the alcohol content increases. Wine makers seem to prefer round numbers in alchohol content. There are spikes in the distribution around every .0 and .5.

# Univariate Analysis

### What is the structure of your dataset?
The red wine dataset consists of 1599 observations of 12 variables (fixed acidity, volatile acidity, citric acid, residual sugar, chlorides, free sulfur dioxide, total sulfur dioxide, density, pH, sulphates, alcohol, and quality). Quality is an ordered categorical variable on a scale from 3 to 8, larger values being the better. Other variables are continuous. 

Most wines (82.5 %) have a quality rating of 5 or 6. 7 is the third most common rating (12.4 %) while all the other quality scores cover only 5 % of the wines. Red wine is acidic (pH 2.7-4.0) and usually has only little residual sugar. Mean alcohol content of wines is 10.4 %.

### What is/are the main feature(s) of interest in your dataset?
The main feature of interest is quality. I'd like to be able to classify wines to high (quality 7 or 8) and low quality (quality 6 or lower) categories based on some combination of physical measures.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?
Based on the shapes of distributions, volatile acidity, citric acid, cholrides and alcohol seem promising. Especially alcohol and citric acid distributions feature curious spikes at round values, suggesting the wine makers might be aiming to have specific characteristics on these features, which implies the winemakers believe those features have something to do with the quality of the wine.

### Did you create any new variables from existing variables in the dataset?
I created variable fixed sulfur dioxide by subracting free sulfur dioxide from total sulfur dioxide. I also combined quality categories into a new binary variable quality.bin. In this variable 'high' is assigned to wines with quality 7 or 8 and the 'low' is assigned to all other wines.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

Several of the distributions were right-skewed. I tried a few transformations (logarithmic, cubic root, power) on some of them, but the shapes of the distributions did not improve. In the end I used the features as they are. (With hindsight, classification models could have benefitted from normalization.) 

# Bivariate Plots Section

### Correlations and summaries by quality
```{r echo=FALSE, Bivariate_Plots}
# Correlations between variables. Original quality scores are used instead of
# binary categories (quality.bin)
cor(wine[c(2:13, 15)])

# Summary statistics by quality category (high or low)
by(wine[, c(2:12, 15)], wine[, 14], summary)
```

Volatile acidity, citric acid, sulphates and alcohol have moderate correlations with wine quality. These features also have have noticably different means between low and high quality wines.

### Quality by fixed acidity

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), fixed.acidity)) + 
  geom_boxplot()
```

No clear trends here. Poor and good wines seem to have higher fixed acidity, but on the other hand there are only a few data points on them, so the effect does not feel very trustworthy.

```{r, echo=FALSE}
ggplot(wine, aes(quality.bin, fixed.acidity)) + 
  geom_boxplot()
ggplot(wine, aes(fixed.acidity, color = quality.bin)) + 
    geom_density()
by(wine$fixed.acidity, wine$quality.bin, summary)
```

Comparing only two quality categories reveals that actually high quality wines tend to have higher fixed acidity. Especially the difference between median values is noticable. Combining quality categories is starting to look like a good idea. 

### Quality by volatile acidity
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), volatile.acidity)) + 
  geom_boxplot()
ggplot(wine, aes(quality.bin, volatile.acidity)) + 
  geom_boxplot()
by(wine$volatile.acidity, wine$quality.bin, summary)
```

There is a clear decreasing trend with volatile acidity when the wine quality increases. High quality wines have lower values in all quartiles.

```{r, echo=FALSE}
ggplot(wine, aes(volatile.acidity, color = as.factor(quality))) + 
    geom_density()
```

With the increasing quality the distribution of volatile acidity moves to left and gets narrower.

```{r, echo=FALSE}
ggplot(wine, aes(volatile.acidity, color = quality.bin)) + 
    geom_density()
```

The lower the volatile acidity, the more likely the wine is to be of high quality. Looks like about 0.38 volatile acidity is the sweet spot for red wines.

### Quality by citric acid
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), citric.acid)) + 
  geom_boxplot()
ggplot(wine, aes(quality.bin, citric.acid)) + 
  geom_boxplot()
by(wine$citric.acid, wine$quality.bin, summary)
```

The very best wines tend to have higher amounts of citric acid.

```{r, echo=FALSE}
ggplot(wine, aes(citric.acid, color = as.factor(quality))) + 
    geom_density()
ggplot(wine, aes(citric.acid, color = quality.bin)) + 
    geom_density()
```

Interesting! On average good wines tend to have a lot of citric acid, but the density plot reveals the picture is more complex. There seems to be three kinds of wines regarding citric acid: low (close to 0), medium (~0.25) and high (~0.4) amounts of citric acid. Good wines have either a little or a lot of citric acid, while other wines can have any amount of it. 

### Quality by residual sugar
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), residual.sugar)) + 
  geom_boxplot()
```

Lots of outliers..

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), residual.sugar)) + 
  geom_boxplot() +
   ylim(0, 4)
ggplot(wine, aes(quality.bin, residual.sugar)) + 
  geom_boxplot() + 
  ylim(0, 4)
ggplot(wine, aes(residual.sugar, color = quality.bin)) + 
  geom_density()
by(wine$residual.sugar, wine$quality.bin, summary)
```

Nothing interesting going on here. 

### Quality by chlorides
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), chlorides)) + 
  geom_boxplot()
```

Again many outliers.

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), chlorides)) + 
  geom_boxplot() +
  ylim(0, 0.2)
ggplot(wine, aes(quality.bin, chlorides)) + 
  geom_boxplot() +
  ylim(0, 0.2)
ggplot(wine, aes(chlorides, color = quality.bin)) + 
  geom_density()
by(wine$chlorides, wine$quality.bin, summary)
```

Good wines appear to have slightly lower amounts of chlorides overall: 0.076 vs 0.089 on average. However, there is a lot of overlap between the distributions.  

### Quality by sulfur dioxide

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), free.sulfur.dioxide)) + 
  geom_boxplot()
```

Quite many outliers.

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), free.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 30)
ggplot(wine, aes(quality.bin, free.sulfur.dioxide)) + 
  geom_boxplot() +
  ylim(0, 30)
ggplot(wine, aes(free.sulfur.dioxide, color = quality.bin)) + 
  geom_density()
by(wine$free.sulfur.dioxide, wine$quality, summary)
```

Average quality wines seem to have a little more free sulfur dioxide on average, but this does not help much in differentiating high quality wines from others. Poor wines (quality score 4) and the best wines (quality score 8) have about the same amount of free sulfur dioxide on average.

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), total.sulfur.dioxide)) + 
  geom_boxplot()
```

Outliers.

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), total.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 120)
ggplot(wine, aes(quality.bin, total.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 120)
ggplot(wine, aes(total.sulfur.dioxide, color = quality.bin)) + 
  geom_density() +
  xlim(0, 120)
by(wine$total.sulfur.dioxide, wine$quality.bin, summary)
```

Total sulfur dioxide is a better indicator of whether a wine is good or bad. Good wines have almost 30 % less total sulfur dioxide than poor wines, on average.

### Total sulfur dioxide by free sulfur dioxide
```{r, echo=FALSE}
ggplot(wine, aes(free.sulfur.dioxide, total.sulfur.dioxide)) + 
  geom_point() + 
  facet_wrap(~quality) + 
  ylim(0, 200)
```

High quality wines seem to be along a line where amount of total sulfur dioxide compared to free sulful dioxide is low

```{r, echo=FALSE}
# Display three boxplots at the same time using grid.arrange from 
# gridExtra package
p1 = ggplot(wine, aes(as.factor(quality), free.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 30)
p2 = ggplot(wine, aes(as.factor(quality), total.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 120)
p3 = ggplot(wine, aes(as.factor(quality), 
                      total.sulfur.dioxide-free.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 120)

grid.arrange(p1, p2, p3, nrow = 1)
```

The pattern is not very clear, though. There is a lot of overlap between the distributions

```{r, echo=FALSE}
ggplot(wine, aes(free.sulfur.dioxide, total.sulfur.dioxide)) + 
    geom_point() + 
  facet_wrap(~quality.bin) + 
  ylim(0, 200)
```

Getting better...

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), fixed.sulfur.dioxide)) + 
  geom_boxplot() +
  ylim(0, 120)
ggplot(wine, aes(quality.bin, fixed.sulfur.dioxide)) + 
  geom_boxplot() + 
  ylim(0, 75)
ggplot(wine, aes(fixed.sulfur.dioxide, color = quality.bin)) + 
  geom_density() + 
  xlim(0, 120)
by(wine$fixed.sulfur.dioxide, wine$quality.bin, summary)
wine[wine$fixed.sulfur.dioxide > 200, ]
```

Fixed sulfur dioxide is even better discriminator than total sulfur dioxide! Good wines have low amounts of fixed sulfur dioxide. The differences between values for quantiles, mean and median are around 30 %. There are two extreme outliers, that seem to be related or duplicated wines. The only difference is in amount of total sulfur dioxide. 

```{r, echo=FALSE}
ggplot(wine, aes(fixed.sulfur.dioxide, color = as.factor(quality))) + 
  geom_density() + 
  xlim(0, 100)
ggplot(wine, aes(fixed.sulfur.dioxide, color = quality.bin)) + 
  geom_density() + 
  xlim(0, 100)
```

Looks like low amounts of fixed sulfur dioxide is a pre-requisite but not a guarantee for a high wine quality.

### Quality by density
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), density)) + 
  geom_boxplot()
ggplot(wine, aes(quality.bin, density)) + 
  geom_boxplot()
by(wine$density, wine$quality.bin, summary)
```

Higher quality wines seem to have lower density. They also have more alcohol, which could cause the correlation. It is probably a good idea to explore how different things affect the density of the wine.

### Quality by pH
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), pH)) + 
  geom_boxplot()
ggplot(wine, aes(quality.bin, pH)) + 
  geom_boxplot()
ggplot(wine, aes(pH, color = quality.bin)) + 
  geom_density()
by(wine$pH, wine$quality.bin, summary)
```

Better wines tend to have slightly lower pH, perhaps in connection to better wines having often higher fixed acidity. The pattern is not very clear though.

### Quality by sulphates
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), sulphates)) + 
  geom_boxplot()
```

Outliers ruining a plot again.

```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), sulphates)) + 
  geom_boxplot() + 
  ylim(0, 1)
ggplot(wine, aes(quality.bin, sulphates)) + 
  geom_boxplot() + 
  ylim(0, 1)
ggplot(wine, aes(sulphates, color = as.factor(quality))) + 
  geom_density() + 
  xlim(0, 1.5)
ggplot(wine, aes(sulphates, color = quality.bin)) + 
  geom_density() + 
  xlim(0, 1.5)
by(wine$sulphates, wine$quality.bin, summary)
```

Higher amounts of sulphates are associated with higher quality, but there are many outliers in average quality wines that muddy the relationship.

### Quality by alcohol
```{r, echo=FALSE}
ggplot(wine, aes(as.factor(quality), alcohol)) + 
  geom_boxplot()
```

The pattern with alcohol is a little bit U-shaped. The worst quality wines tend to have more alcohol than average wines, and then the better than average wines have increasing amounts of alcohol.

```{r, echo=FALSE}
ggplot(wine, aes(quality.bin, alcohol)) + 
  geom_boxplot()
```

With lower resolution the pattern becomes clearer. Better wines tend to have higher amounts of alcohol.

```{r, echo=FALSE}
ggplot(wine, aes(alcohol, color = as.factor(quality))) + 
    geom_density()
ggplot(wine, aes(alcohol, color = quality.bin)) + 
    geom_density()
by(wine$alcohol, wine$quality.bin, summary)
```

Wines with more than 12 % alcohol are likely to have high quality, and wines with less than 10 % alcohol are likely poor.

### Composition of density
```{r, echo=FALSE}
# Plotting the features with high correlations with density and
# displaying them in one arrangement
p1 <- qplot(fixed.acidity, density, data = wine) + 
  geom_smooth(method = 'lm')
p2 <- qplot(citric.acid, density, data = wine) + 
  geom_smooth(method = 'lm')
p3 <- qplot(residual.sugar, density, data = wine) + 
  geom_smooth(method = 'lm')
p4 <- qplot(alcohol, density, data = wine) + 
  geom_smooth(method = 'lm')
p5 <- qplot(pH, density, data = wine) + 
  geom_smooth(method = 'lm')
grid.arrange(p1, p2, p3, p4, p5)
```

Many of the features are associated with density, which makes sense. Fixed acidity and alcohol seem to have the strongest association. pH has strong correlations with acidity measures, so its association with density is likely to be result of that.

### Composition of pH and acidity
```{r, echo=FALSE}
# Plotting the features with high correlations with pH and
# displaying them in one arrangement
p1 <- qplot(fixed.acidity, pH, data = wine) + 
  geom_smooth(method = 'lm')
p2 <- qplot(volatile.acidity, pH, data = wine) + 
  geom_smooth(method = 'lm')
p3 <- qplot(citric.acid, pH, data = wine) + 
  geom_smooth(method = 'lm')
grid.arrange(p1, p2, p3, nrow = 2)
```

The higher the acidity, the lower the pH. Surprisingly, higher volatile acidity has a weak correlation with higher pH. Maybe volatile acids are "escaping" from the wine?

```{r, echo=FALSE}
# Plotting the comparisons of different acidity measures and
# displaying them in one arrangement
p1 <- qplot(fixed.acidity, volatile.acidity, data = wine) + 
  geom_smooth(method = 'lm')
p2 <- qplot(fixed.acidity, citric.acid, data = wine) + 
  geom_smooth(method = 'lm')
p3 <- qplot(volatile.acidity, citric.acid, data = wine) + 
  geom_smooth(method = 'lm')
grid.arrange(p1, p2, p3, nrow = 2)
```

Fixed and volatile acidity do not have much to do with each other, but citric acid has to do with both of them! Citric acid has positive correlation with fixed acidity and negative correlation with volatile acidity. These relationships look somewhat nonlinear. 

```{r, echo=FALSE}
# Exploring effects of power transformations to relationship 
# between fixed acidity and citric acid
p1 <- qplot(fixed.acidity, citric.acid, data = wine) + 
  geom_smooth(method = 'lm')
p2 <- qplot(fixed.acidity, citric.acid^2, data = wine) + 
  geom_smooth(method = 'lm')
p3 <- qplot(fixed.acidity, citric.acid^3, data = wine) + 
  geom_smooth(method = 'lm')
p4 <- qplot(fixed.acidity, citric.acid^4, data = wine) + 
  geom_smooth(method = 'lm')
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

Looks like fixed acidity is linearly related to citric acid to some power, perhaps  4.

```{r, echo=FALSE}
# Exploring effects of power transformations to relationship 
# between volatile acidity and citric acid
p1 <- qplot(volatile.acidity, citric.acid, data = wine) + 
  geom_smooth(method = 'lm')
p2 <- qplot(volatile.acidity, citric.acid^2, data = wine) + 
  geom_smooth(method = 'lm')
p3 <- qplot(volatile.acidity, citric.acid^3, data = wine) + 
  geom_smooth(method = 'lm')
p4 <- qplot(volatile.acidity, citric.acid^4, data = wine) + 
  geom_smooth(method = 'lm')
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

Here the relationship looks most linear when citric acid values are squared, but the approximation is very rough. 

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

Merging quality categories to just high (7 or 8) and low (6 or below) turned out to be helpful in clarifying the differences between wines. In summary, high quality wines tend to have relatively:

* low volatile acidity (around 0.4)
* either low or high amounts of citric acid (around 0.1 or 0.5)
* low amounts of fixed sulfur dioxide
* often highish amounts of sulphates
* on average 11.5 % alcohol compared to 10.25 % in lower quality wines

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

In addition to relationships between physical measures and quality I investigated the composition of acidity in more detail, because two acidity measures correlated with quality, and they interact with each other. Interestingly volatile acidity has negative correlation and fixed acidity has positive correlation with citric acid, but volatile and fixed acidity do not correlate much with each other. The relationships seem to be linear in some power of citric acid, perhaps around 2 (volatile acidity) and 4 (fixed acidity). I also looked at the composition of density, which is likely a result of other measured physical properties.   

### What was the strongest relationship you found?

The strongest correlation I found was between total sulfur dioxide and fixed sulfur dioxide, but the correlation is a result of how the variable was created. After that fixed acidity and pH  have the highest correlation (-0.68). Other similarly strong correlations include:

* fixed acidity and citric acid
* fixed acidity and density
* free sulfur dioxide and total sulfur dioxide

However, for the most interesting correlation is between alcohol and quality (0.48). High quality wines tend to have a lot of alcohol.

# Multivariate Plots Section

### Acidity vs. quality
```{r echo=FALSE, Multivariate_Plots}
# Scatterplots of different acidity measures and their relationship with 
# two quality categories
ggplot(wine, aes(fixed.acidity, volatile.acidity, color = citric.acid)) +
  geom_point() + 
  facet_wrap(~quality.bin) + 
  scale_color_continuous(low = 'grey', high = 'red') + 
  geom_abline(intercept = -0.2, slope = 0.08)

by(wine[c('fixed.acidity', 'volatile.acidity')], wine$quality.bin, cor)
by(wine[c('volatile.acidity', 'citric.acid')], wine$quality.bin, cor)
by(wine[c('fixed.acidity', 'citric.acid')], wine$quality.bin, cor)
```

Plotting the wines based on their acidity measures reveals two clusters of high-quality wines:

* low fixed acidity and citric acid, high volatile acidity
* low volatile acidity, high fixed acidity and citric acid

Although there is overlap, many low quality wines could already be identified from this plot: wines presented with red dots above the black line and grey dots below it are likely to be of poor quality (the location of the line is approximate and only for illustration). Interestingly the correlations between acidity do not change markedly between the quality classes. Effect is probably an interaction between features.

```{r,echo=FALSE}
# Normalizing fixed.adicity and volatile.acidity and
# creating an interaction feature
wine$fixed.acidity.norm <- scale(wine$fixed.acidity)
wine$volatile.acidity.norm <- scale(wine$volatile.acidity)
wine$acidity.inter <- wine$volatile.acidity.norm * wine$fixed.acidity.norm
by(wine[c('acidity.inter', 'citric.acid')], wine$quality.bin, cor)
```

Low quality wines have almost no correlation between citric.acid and the new interaction term, while in high quality wines the correlation is moderate.

### Sulphates, sulfur dioxide and alcohol vs. quality
```{r, echo=FALSE}
# Scatterplots of sulphates, sulfur dioxide and alcohol measures and 
# their relationship with two quality categories
ggplot(wine, aes(sulphates, fixed.sulfur.dioxide, color = alcohol)) + 
  geom_point() +
  scale_color_continuous(low = 'grey', high = 'red') + 
  facet_wrap(~quality.bin) + 
  geom_abline(intercept = -70, slope = 200) + 
  ylim(0, 150) + 
  xlim(0, 1.7)

by(wine[c('sulphates', 'fixed.sulfur.dioxide')], wine$quality.bin, cor)
by(wine[c('alcohol', 'fixed.sulfur.dioxide')], wine$quality.bin, cor)
by(wine[c('sulphates', 'alcohol')], wine$quality.bin, cor)
```

Good quality wines form a rather tight cluster. Again it is possible to identify many poor quality wines visually: any grey wine and all wines above the black line are likely to be of poor quality. This time correlations between features are different for different wine qualities. For instance, in low quality wines increases in fixed sulfur dioxide are negatively correlated with alcohol, but in high quality wines the relationship is reverse. Correlations between sulphates and fixed sulfur dioxide ans sulphates and alchol show similar patterns, but to a lesser extent. Classification algorithms could probably do a good job at identifying high-quality wines (quality 7 or 8) using the following features: 

* alcohol
* fixed acidity
* volatile acidity
* citric acid
* fixed sulfur dioxide
* sulphates

### Classification models
Next three classification models are trained on the promising features and their performance is assesed. The goal is to achieve a proof of concept for identifying high quality wines based on the chemical properties. Therefore the models are used 'out of the box'. Model parameters are not optimized and outliers are not removed from the data. The purpose of the models is just to quickly validate the hypothesis that the identified promising features are useful for predicting wine quality.

First the data is randomly split to training and test sets. 70 % of the data is used for training the models and the rest is spared for evaluating their accuracy. The classification models used are k-nearest neighbors (KNN), support vector machine (SVM) and random forest. They are all well-known algorithms that usually perform well, and use different approaches in modeling. 

Following parameters for the models are used.

KNN: k = 3. This a typical value for number of neighbors to consider in prediction.

SVM: scale = TRUE, kernel = 'radial', gamma = 1/6 (1/(data dimension)), cost (C) = 1. These parameters are the defaults in support vector machine implementation in e1071 package. Features are normalized, and a radial kernel is used.

Random Forest: ntree = 500, mtry = sqrt(6), replace = TRUE, cutoff = 1/2, nodesize = 1. There parameters are the defaults for randomForest in randomForest package. 500 trees are grown to the maximum size, where minimum number of nodes in a leaf is 1. 

```{r, echo=FALSE}
# Split data to training and test sets
set.seed(3845939)
indices <- sample(nrow(wine), 0.7 * nrow(wine))
train <- wine[indices, c(2:4, 11, 12, 14, 15)]
test <- wine[-indices, c(2:4, 11, 12, 14, 15)]

# Fit k-nearest neighbors model and make predictions on test data
# Classifications need to be removed from test and training sets
# and training classifications provided in separate vector
cl <- train$quality.bin      # training classifications for knn
train_knn <- train[, -6]
test_knn <- test[, -6]
prediction_1 <- knn(train_knn, test_knn, cl, k = 3)

# Fit support vector machine and make predictions on test data
model_2 <- svm(quality.bin ~ alcohol + fixed.acidity + volatile.acidity + 
                 citric.acid + fixed.sulfur.dioxide + sulphates, data = train)
prediction_2 <- predict(model_2, newdata = test)

# Fit random forest and make predictions on test data
model_3 <- randomForest(quality.bin ~ alcohol + fixed.acidity + volatile.acidity + 
                 citric.acid + fixed.sulfur.dioxide + sulphates, data = train)
prediction_3 <- predict(model_3, newdata = test)
```

```{r, echo=FALSE}
# Print prediction results

cat('K nearest neighbors predictions:')
table(prediction_1, test$quality.bin)  # Tabulate predictions vs. correct values
round((392 + 23) / nrow(test_knn), 2)  # Calculate accuracy percentage

cat('Support vector machine predictions:')
table(prediction_2, test$quality.bin)  # Tabulate predictions vs. correct values
round((408 + 13) / nrow(test), 2)      # Calculate accuracy percentage

cat('Random forest predictions:')
table(prediction_3, test$quality.bin)  # Tabulate predictions vs. correct values
round((405 + 31) / nrow(test), 2)      # Calculate accuracy percentage
```

Indeed, k nearest neigbors, support vector machine and random forest all work pretty well even without any optimization. In this case random forest has the best performance, achieving 91 % classification accuracy on the test set. Precision of identifying high quality wines is 0.49 and recall is 0.72. In practical terms, if the random forest model is correct about half of the time when it predicts a wine is good, and about 97 % of the time when it predicts a wine is not good. Because the baseline changes of a wine being of high quality in the test set is only 13 %, the result is a significant improvement.

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

Combination of different acidity measures (fixed acidity, volatile acidity and citric acid) turned out to be useful in visually differentiating between high and low quality wines, as did the combination of fixed sulfur dioxide, sulphates and alcohol. The clustering looked much tighter than I had expected based on the bivariate comparisons. After seeing these plots it was not a surprise that classification models performed well at predicting wine quality. 

### Were there any interesting or surprising interactions between features?

The biggest surprise was the interaction between sulphates and fixed sulphur dioxide. Neither of them was a strong canditate as a predictor, but together they collected high-quality wines in a tight cluster. 

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

I tried three classification models on the promising features identified during the exploratory analysis. All of them worked well "out of the box", acchieving around 90 % accuracy. In this case random forest had the best performance with 91 % accuracy on the test set. This means that based on six physical measures of the wine, the random forest model can correctly predict nine times out of ten whether the wine is of high quality. The performance of models could likely be improved further by little optimization. For instance, k-value in k-nearest neighbors model was pulled from a hat, and other models were fitted with default parameters.

------

# Final Plots and Summary

This report set out to explore the red wine dataset originally collected by P. Cortez, A. Cerdeira, F. Almeida, T. Matos and J. Reis (Modeling wine preferences by data mining from physicochemical properties. In Decision Support Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236). The goal was to find out whether it would be possible to identify high quality wines, as defined by subjective expert evaluations, just based on a few of their measurable chemical properties. The dataset consists of 11 physical measurements of 1599 Portuguese vinho verde red wines.

### Plot One
```{r echo=FALSE, Plot_One}
# Rename quality.bin levels to include their range of scores
levels(wine$quality.bin) <- c('Low (3-6)', 'High (7-8)')

ggplot(wine, aes(as.factor(quality))) + 
  geom_histogram(fill = 'blue') + 
  xlab('Quality') + ylab('Count') + 
  ggtitle('Quality scores')
summary(wine$quality)
sd(wine$quality)
table(wine$quality.bin)
```

### Description One
Wine quality is measured on a discrete scale from 0 (very bad) to 10 (very excellent). The distribution of quality scores for the wines is bell-shaped, with median 6 and standard deviation 0.81. Extreme scores are not used and in practice wine quality varies between 3 and 8. As many of the categories have relatively few observations, and the main interest is in differentiating good wines from the rest, it makes sense to combine categories. Only a minority of wines - 217 out of 1599, or 13.5 % -  is of high quality.

### Plot Two
```{r echo=FALSE, Plot_Two}
ggplot(wine, aes(alcohol, color = wine$quality.bin)) + 
  geom_density() + 
  xlab('Alcohol % vol') + 
  ylab('Density') + 
  ggtitle('Quality by alcohol') + 
  scale_color_manual(values = c('red', 'blue'), name = 'Quality category')

by(wine$alcohol, wine$quality.bin, summary)
cor(wine$quality, wine$alcohol)
```

### Description Two
Amount of alcohol has the strongest association with wine quality. Better wines tend to have more alcohol, 11.5 % on average, in contrast to 10.25 % in low quality wines. The correlation between wine quality (original 10-point scale) and amount of alcohol is 0.48. Wines with more than 11 % alcohol are likely to be high quality wines.

### Plot Three
```{r echo=FALSE, Plot_Three}
#ggplot(wine, aes(sulphates, fixed.sulfur.dioxide, color = alcohol)) + 
#  geom_point() + 
#  scale_color_continuous(low = 'grey', high = 'red', name = 'Alcohol % vol') +
#  facet_wrap(~quality.bin) + 
#  geom_abline(intercept = -70, slope = 200, linetype = 'dashed') +
#  xlab('Potassium sulphate g/l') + ylab('Fixed sulfur dioxide mg/l') + 
#  ggtitle('Quality by sulphates, fixed sulfur dioxide and alcohol') + 
#  xlim(0, 1.7) + ylim(0, 150)

ggplot(wine, aes(fixed.acidity, volatile.acidity, color = citric.acid)) + 
  geom_point() + 
  scale_color_continuous(low = 'grey', high = 'red', name = 'Citric acid g/l') + 
  facet_wrap(~quality.bin) + 
  geom_abline(intercept = -0.2, slope = 0.08, linetype = 'dashed') +
  xlab('Tartaric acid g/l') + ylab('Acetic acid g/l') + 
  ggtitle('Quality by acidity measures')
by(wine[c('fixed.acidity', 'volatile.acidity', 'citric.acid')], 
   wine$quality.bin, summary)
by(wine[c('acidity.inter', 'citric.acid')], wine$quality.bin, cor)
```

### Description Three
Three acidity measures, fixed acidity (tartaric acid), volatile acidity (acetic acid), and, and citric acid, differentiate high-quality wines from low-quality wines rather well, although the relationship is not straight-forward. On average high quality wines tend to have higher fixed acidity (8.8 vs. 8.2 g/l) and citric acid (0.38 vs. 0.25 g/l), and lower volatile acidity (0.41 vs. 0.55 g/l) than low quality wines. However, the largest differences come up when interactions between different acidity measures are taken into account. Low quality wines show almost no correlation (-0.03) between the interaction term of volatile and fixed acidity (volatile acidity times fixed acidity) and citric acid, which means that low quality wines can have wide range of citric acid levels regardless of the the interaction of the two other measures. With high quality wines this picture changes. The amount of citric acid tends to decrease in high quality wines as the value of interaction term between volatile and fixed acidity increases. The correlation is moderate -0.20. As a result of these interactions, it is possible to identify clusters of high and low quality wines even visually, as the above plot demonstrates. Dashed lines help illustrate the borders of distinct clusters. In the plot, wines represented by red dots above the dashed line and by grey dots below it are likely to have low quality. The situation is similar whe interactions between amounts of sulphates, fixed sulfur dioxide and alcohol are investigated. 

Finally, the usability of the promising features (fixed acidity, volatile acidity, citric acid, sulphates, fixed sulfur dioxide and alcohol) for identification of high quality wines was tested by trying to predict the wine quality using k-nearest neigbors, support vector machine and random forest algorithms. The purpose of these models was to act as a proof of concept, so parameter optimization and outlier removal were skipped. Still, the best performing algorithm, random forest, was able to acchieve 91 % overall classification accuracy, and 49 % precision and 72 % recall on identifying high qualty wines on the test set.  

------

# Reflection
The dataset I explored contained physical measurements of 1599 red wines, along with subjective quality scores. I started by investigating the distributions of individual variables. After that I identified promising correlations between the variables in an effort to find a set of features that could be used to predict wine quality. Instead of the full quality scale I was only interested in differentiating good wines (score 7 or 8) from the rest. Initially the dataset felt confusing and it didn't look like there was any interesting patterns, but systematically plotting comparisons of variables slowly revealed many interesting relationships. During the analysis the largest surprise was that some of the variables that did not look very good predictors alone, worked very well when combined together. In the end I used six identified features to build three classification models. Random forest performed best, achieving 91 % classification accuracy on the test set. The performance of the models could be improved by optimization and possibly by adding new features. Some of the less promising features could still contain useful information. 

I made a couple of detours during the analysis by investigating the relationships of density and pH with other variables they had high correlations with, and by looking to interactions of different acidity measures in detail. In the end I did not get anything useful out of this exploration, except perhaps the decision to leave density and pH out of further analysis, because the information they contain seemed likely to be already accounted for by other variables. 
